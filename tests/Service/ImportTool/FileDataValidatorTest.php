<?php

declare(strict_types=1);

namespace App\Tests\Service\ImportTool;

use App\Entity\Product;
use App\Repository\ProductRepository;
use App\Service\Reporter\FileImportReporter;
use App\Service\ImportTool\FileDataValidator;
use PHPUnit\Framework\MockObject\MockObject;
use PHPUnit\Framework\TestCase;

class FileDataValidatorTest extends TestCase
{
    /**
     * @var FileDataValidator
     */
    private $validator;

    /**
     * @var array
     */
    private $dataToValidate;

    /**
     * @var FileImportReporter
     */
    private $reporter;

    /**
     * @var MockObject
     */
    private $mockProductRepository;

    /**
     * @var string
     */
    private const DATA_TO_VALIDATE_KEY = 'dataToValidate';

    /**
     * @var string
     */
    private const EXPECTED_RESULT_KEY = 'expectedResult';

    /**
     * @var string
     */
    private const EXPECTED_MESSAGE_KEY = 'expectedMessage';

    /**
     * @return void
     */
    public function setUp(): void
    {
        parent::setUp(); // TODO: Change the autogenerated stub

        $this->mockProductRepository = $this->getMockBuilder(ProductRepository::class)
                                ->disableOriginalConstructor()
                                ->setMethods(['FindOneBy'])
                                ->getMock();

        $this->reporter = new FileImportReporter();

        $this->mockProductRepository->expects($this->any())
            ->method('findOneBy')
            ->willReturnCallback(function ($code){
                    if ('P00050' === $code) {
                        return new Product('First one', 'ddd', 'P00050', 10, 20, true);
                    }
                    return null;
                }
            );

        $this->validator = new FileDataValidator($this->reporter, $this->mockProductRepository);
    }

    /**
     * @param $dataToValidate
     * @param $result
     * @param $expectedMessage
     * @return void
     * @dataProvider provideInvalidDataToValidate
     */
    public function testValidateInvalidProducts($dataToValidate, $result, $expectedMessage): void
    {
        $this->dataToValidate[FileDataValidator::PRODUCT_NAME_COLUMN] = $dataToValidate[FileDataValidator::PRODUCT_NAME_COLUMN];
        $this->dataToValidate[FileDataValidator::PRODUCT_DESCRIPTION_COLUMN] = $dataToValidate[FileDataValidator::PRODUCT_DESCRIPTION_COLUMN];
        $this->dataToValidate[FileDataValidator::PRODUCT_CODE_COLUMN] = $dataToValidate[FileDataValidator::PRODUCT_CODE_COLUMN];
        $this->dataToValidate[FileDataValidator::PRODUCT_DISCONTINUED_COLUMN] = $dataToValidate[FileDataValidator::PRODUCT_DISCONTINUED_COLUMN];
        $this->dataToValidate[FileDataValidator::PRODUCT_STOCK_COLUMN] = $dataToValidate[FileDataValidator::PRODUCT_STOCK_COLUMN];
        $this->dataToValidate[FileDataValidator::PRODUCT_COST_COLUMN] = $dataToValidate[FileDataValidator::PRODUCT_COST_COLUMN];

        $isValid = $this->validator->validate($this->dataToValidate);

        $this->assertSame($isValid, $result[0]);
        if ($result[0] != true) {
            $realMessage = $this->reporter->getMessages();
            $this->assertSame($expectedMessage[0], $realMessage[0]);
        }
    }

    /**
     * @return array
     */
    public function provideInvalidDataToValidate(): array
    {
        return[
                [
                    FileDataValidatorTest::DATA_TO_VALIDATE_KEY => [
                                FileDataValidator::PRODUCT_NAME_COLUMN => null,
                                FileDataValidator::PRODUCT_DESCRIPTION_COLUMN => 'description-1',
                                FileDataValidator::PRODUCT_CODE_COLUMN => 'P00011000',
                                FileDataValidator::PRODUCT_DISCONTINUED_COLUMN => '',
                                FileDataValidator::PRODUCT_STOCK_COLUMN => 9,
                                FileDataValidator::PRODUCT_COST_COLUMN => 100
                    ],
                    FileDataValidatorTest::EXPECTED_RESULT_KEY => [false],
                    FileDataValidatorTest::EXPECTED_MESSAGE_KEY => ['Invalid product name']
                ],
                [
                    FileDataValidatorTest::DATA_TO_VALIDATE_KEY => [
                        FileDataValidator::PRODUCT_NAME_COLUMN => 'Some name',
                        FileDataValidator::PRODUCT_DESCRIPTION_COLUMN => null,
                        FileDataValidator::PRODUCT_CODE_COLUMN => 'P000250',
                        FileDataValidator::PRODUCT_DISCONTINUED_COLUMN => 'yes',
                        FileDataValidator::PRODUCT_STOCK_COLUMN => 9,
                        FileDataValidator::PRODUCT_COST_COLUMN => 100
                    ],
                    FileDataValidatorTest::EXPECTED_RESULT_KEY => [false],
                    FileDataValidatorTest::EXPECTED_MESSAGE_KEY => ['Invalid product description']
                ],
                [
                    FileDataValidatorTest::DATA_TO_VALIDATE_KEY => [
                        FileDataValidator::PRODUCT_NAME_COLUMN => 'Some name',
                        FileDataValidator::PRODUCT_DESCRIPTION_COLUMN => 'description',
                        FileDataValidator::PRODUCT_CODE_COLUMN => null,
                        FileDataValidator::PRODUCT_DISCONTINUED_COLUMN => 'yes',
                        FileDataValidator::PRODUCT_STOCK_COLUMN => 9,
                        FileDataValidator::PRODUCT_COST_COLUMN => 100
                    ],
                    FileDataValidatorTest::EXPECTED_RESULT_KEY => [false],
                    FileDataValidatorTest::EXPECTED_MESSAGE_KEY => ['Invalid product code']
                ],
                [
                    FileDataValidatorTest::DATA_TO_VALIDATE_KEY => [
                        FileDataValidator::PRODUCT_NAME_COLUMN => 'name',
                        FileDataValidator::PRODUCT_DESCRIPTION_COLUMN => 'description',
                        FileDataValidator::PRODUCT_CODE_COLUMN => 'P00053',
                        FileDataValidator::PRODUCT_DISCONTINUED_COLUMN => 'yes',
                        FileDataValidator::PRODUCT_STOCK_COLUMN => 3,
                        FileDataValidator::PRODUCT_COST_COLUMN => 4
                    ],
                    FileDataValidatorTest::EXPECTED_RESULT_KEY => [false],
                    FileDataValidatorTest::EXPECTED_MESSAGE_KEY => ['Stock and cost are less than rule']
                ],
                [
                    FileDataValidatorTest::DATA_TO_VALIDATE_KEY => [
                        FileDataValidator::PRODUCT_NAME_COLUMN => 'name',
                        FileDataValidator::PRODUCT_DESCRIPTION_COLUMN => 'description',
                        FileDataValidator::PRODUCT_CODE_COLUMN => 'P00057',
                        FileDataValidator::PRODUCT_DISCONTINUED_COLUMN => 'yes',
                        FileDataValidator::PRODUCT_STOCK_COLUMN => 3,
                        FileDataValidator::PRODUCT_COST_COLUMN => 10000
                    ],
                    FileDataValidatorTest::EXPECTED_RESULT_KEY => [false],
                    FileDataValidatorTest::EXPECTED_MESSAGE_KEY => ['Cost is more than rule']
                ],
                [
                    FileDataValidatorTest::DATA_TO_VALIDATE_KEY => [
                        FileDataValidator::PRODUCT_NAME_COLUMN => 'name0',
                        FileDataValidator::PRODUCT_DESCRIPTION_COLUMN => 'description 0',
                        FileDataValidator::PRODUCT_CODE_COLUMN => 'P00055',
                        FileDataValidator::PRODUCT_DISCONTINUED_COLUMN => 'yes',
                        FileDataValidator::PRODUCT_STOCK_COLUMN => 5,
                        FileDataValidator::PRODUCT_COST_COLUMN => 100
                    ],
                    FileDataValidatorTest::EXPECTED_RESULT_KEY => [true],
                    FileDataValidatorTest::EXPECTED_MESSAGE_KEY => [null]
                ],
//                [['name4', 'description4', 'P00050', 'no', 131, 115], [false], ['This product already exists']],
        ];
    }
}